name: Notebook Validation

on:
  push:
    branches: [ main ]
    paths:
      - '*.ipynb'
      - 'requirements.txt'
  pull_request:
    branches: [ main ]
    paths:
      - '*.ipynb'
      - 'requirements.txt'

jobs:
  validate-notebooks:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install nbformat nbconvert jupyter
    
    - name: Validate notebook JSON structure
      run: |
        python -c "
        import nbformat
        import sys
        
        notebooks = ['Titans_MIRAS_Scratch.ipynb', 'Titans_MIRAS_Hybrid.ipynb']
        
        for nb_path in notebooks:
            try:
                with open(nb_path, 'r', encoding='utf-8') as f:
                    nb = nbformat.read(f, as_version=4)
                print(f'✅ {nb_path}: Valid notebook structure')
                print(f'   Cells: {len(nb.cells)}')
            except Exception as e:
                print(f'❌ {nb_path}: Invalid - {e}')
                sys.exit(1)
        "
    
    - name: Check for common issues
      run: |
        python -c "
        import nbformat
        import sys
        
        notebooks = ['Titans_MIRAS_Scratch.ipynb', 'Titans_MIRAS_Hybrid.ipynb']
        issues = []
        
        for nb_path in notebooks:
            with open(nb_path, 'r', encoding='utf-8') as f:
                nb = nbformat.read(f, as_version=4)
            
            for i, cell in enumerate(nb.cells):
                if cell.cell_type == 'code':
                    source = ''.join(cell.source)
                    # Check for hardcoded paths
                    if '/home/' in source or 'C:\\\\' in source or 'D:\\\\' in source:
                        issues.append(f'{nb_path} cell {i+1}: Contains hardcoded path')
        
        if issues:
            print('⚠️ Potential issues found:')
            for issue in issues:
                print(f'  - {issue}')
        else:
            print('✅ No common issues detected')
        "

  syntax-check:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install nbformat
    
    - name: Check Python syntax in notebooks
      run: |
        python -c "
        import nbformat
        import ast
        import sys
        
        notebooks = ['Titans_MIRAS_Scratch.ipynb', 'Titans_MIRAS_Hybrid.ipynb']
        errors = []
        
        for nb_path in notebooks:
            with open(nb_path, 'r', encoding='utf-8') as f:
                nb = nbformat.read(f, as_version=4)
            
            for i, cell in enumerate(nb.cells):
                if cell.cell_type == 'code':
                    source = ''.join(cell.source)
                    try:
                        ast.parse(source)
                    except SyntaxError as e:
                        errors.append(f'{nb_path} cell {i+1}: {e.msg} at line {e.lineno}')
        
        if errors:
            print('❌ Syntax errors found:')
            for error in errors:
                print(f'  - {error}')
            sys.exit(1)
        else:
            print('✅ All cells have valid Python syntax')
        "
